# spring-cloud-oauth2-jwt
## 一、概述
  针对Oauth2保护应用，会有一个缺陷，每次请求都需要经过UAA服务去验证当前Token的合法性，并且需要查询该Token
对应的用户的权限。在高并发情况下，会有性能瓶颈，改善方法如下。
    方式一、将UAA服务集群部署并且增加缓存。
    方式二、采用OAuth2和jwt的方式，避免每次请求都需要调用UAA服务，采用OAuth2和JWT方式，Uaa服务只验证一次，返回jwt。
    返回的jwt包含了用户信息，包括权限信息等

## 二、JWT简介 
### 2.1、什么是JWT
  JSON Web Token（jwt）是一种开放的标准协议（RFC 7519），JWT定义了一种紧凑且自包含的标准，该标准旨在将
各个主体的信息包装为JSON对象。主体信息是通过数字签名进行加密和验证的。常使用HMAC算法或RSA算法对JWT进行签名。
* 紧凑型：由于加密后的字符串，JWT数据体积非常小，可以通过POST请求参数或请求头发送。
* 自包含：JWT包含了主体的所有信息，所以避免了没个请求都需要想UAA服务验证身份，降低了度武器的负载。
### 2.2、JWT的结构
  JWT由2个部分组成，分别以"."分隔，组成部分如下。
* Header（头）
* Payload（有效载荷）
* Signature（签名）
  因此，JWT的通用格式如下：
```text
xxxx.yyyy.zzzzz
```
#### 2.2.1、Header
  Header通常由两部分组成：令牌的类型（即JWT）和使用的算法类型，如HAMC、SHA256和RSA等。
```json
{
  "alg":"HS256",
  "typ":"JWT"
}
```  
将Header用Base64编码作为JWT的第一部分
#### 2.2.2、Payload
  包含了用户的一些信息和Claim（声明、权利）。有3中类型的Claim：保留、公开和私人。
```json
{
  "sub":"1234567890",
  "name":"lihongxu",
  "admin":true
}
```  
将Payload用Base64编码作为JWT的第二部分
#### 2.2.3、Signature
  要创建签名部分，需要将Base64编码后的Header、Payload和私钥进行签名，
```text
HAMCSHA256(
    base64Urlencode(header)+"."+
    base64Urlencode(payload),
    secret
    )
```  
### 2.3、应用场景
* 认证：一旦用户登录成功获取jwt后，后续的没个请求将携带该jwt。该jwt包含了用户信息、权限点等信息。根据该jwt包含
的信息，资源服务可以控制该jwt可以访问的资源范围。
* 信息交换：JWT是各方之间安全传输信息的一种方式，JWT使用签名加密，安全性很高。另外，当使用header和payload计算签名
时，还可以验证内容是否被篡改。
* 单点登录：jwt能够在不同的域中使用，故可以做单点登录方案。
### 1.4、认证流程
```text
  +---------+                      +---------------+             
  |  浏览器  |                      |     Server    |          
  |         |                      |     服务器     |          
  +---------+                      +---------------+          
       |                                   |
       |>-----(1)------- 登录 ------------->|------->
       |            username+password      |        |
       |                                   | （2）用私钥创建JWT
       |                                   |        |
       |<-----(3)---- 返回JWT给浏览器-------<|<--------
       |                                   |   
       |>-----(4)---- 发发送请求 ----------->|------->
       |            在请求头增加JWT          |        | 
       |                                   | （5）检查JWT解密，获取用户信息                                                                    （2）用私钥创建JWT   
       |                                   |        |
       |<-----(6)---- 客户响应       -------<|<-------  
       |                                   |
```
    
 
 
 
 